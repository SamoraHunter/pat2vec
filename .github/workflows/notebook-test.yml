name: Notebook Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      DEBIAN_FRONTEND: noninteractive

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Install Python 3.10 and Git
        run: |
          apt-get update
          apt-get install -y gnupg lsb-release software-properties-common curl git

          # Skip GPG key verification by marking the repository as trusted
          echo "deb [trusted=yes] http://ppa.launchpadcontent.net/deadsnakes/ppa/ubuntu $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/deadsnakes-ppa.list

          apt-get update
          apt-get install -y python3.10 python3.10-venv python3.10-distutils

          # Ensure python3.10 is the default
          ln -sf /usr/bin/python3.10 /usr/local/bin/python
          ln -sf /usr/bin/python3.10 /usr/local/bin/python3

          # Disable SSL verification for curl
          export CURL_CA_BUNDLE=""
          export SSL_CERT_FILE=""

          # Install pip for Python 3.10
          curl -sS https://bootstrap.pypa.io/get-pip.py | python3.10
          python3.10 -m ensurepip --upgrade
          ln -sf /usr/local/bin/pip3.10 /usr/local/bin/pip
          ln -sf /usr/local/bin/pip3.10 /usr/local/bin/pip3

          # Verify python and pip installations
          python --version
          pip --version

      - name: Set environment variables
        run: |
          echo "PYTHONHTTPSVERIFY=0" >> $GITHUB_ENV
          echo "CURL_CA_BUNDLE=" >> $GITHUB_ENV
          echo "SSL_CERT_FILE=" >> $GITHUB_ENV
          echo "GIT_SSL_NO_VERIFY=true" >> $GITHUB_ENV

      - name: Clone pat2vec repository
        run: |
          mkdir -p global_files
          cd global_files
          git -c http.sslVerify=false clone https://github.com/SamoraHunter/pat2vec.git

      - name: Setup pat2vec
        run: |
          cd global_files/pat2vec
          sed -i 's/apt-get install/apt-get install -y/g' install_pat2vec.sh
          sed -i 's/pip install/pip install --trusted-host pypi.org --trusted-host files.pythonhosted.org/g' install_pat2vec.sh
          bash install_pat2vec.sh 

      - name: Activate pat2vec environment
        run: |
          source global_files/pat2vec/pat2vec_env/bin/activate
          echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          source $VIRTUAL_ENV/bin/activate
          pip install --no-cache-dir pytest nbconvert nbformat

      - name: Run notebook test
        run: |
          source $VIRTUAL_ENV/bin/activate
          pytest notebooks/test_notebook.py
